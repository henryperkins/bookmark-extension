# Project Structure

## Directory Organization

```
bookmark-extension/
├── manifest.json              # MV3 extension manifest
├── serviceWorker.js           # Main orchestrator (background service worker)
├── openaiClient.js            # Azure OpenAI API wrapper
├── embeddings.js              # Vector generation & duplicate detection
├── tagger.js                  # AI-powered tag generation
├── scraper.js                 # Page content extraction coordinator
├── writer.js                  # Bookmark update/deletion operations
├── bookmarksCrud.js           # CRUD operations for bookmarks
├── exporter.js                # Netscape HTML export
├── importer.js                # HTML import parser
├── offscreen.html             # Offscreen document for DOM parsing
├── offscreenScraper.js        # DOM parsing implementation
├── lib/
│   └── cosine.js              # Cosine similarity calculation
├── utils/
│   ├── rateLimiter.js         # Custom rate limiting (no external deps)
│   ├── storageManager.js      # Vector cache with expiration
│   ├── notificationManager.js # Progress notifications
│   ├── duplicateDetector.js   # Similarity comparison logic
│   ├── tagValidator.js        # Tag quality filtering
│   ├── folderOrganizer.js     # Folder suggestion logic
│   ├── syncManager.js         # Conflict resolution
│   ├── offscreen.js           # Offscreen document lifecycle
│   └── url.js                 # URL normalization utilities
├── options/
│   ├── options.html           # Settings UI
│   └── options.js             # Settings logic
├── popup/                     # React app (source)
│   ├── src/
│   │   ├── App.tsx            # Main UI component
│   │   └── main.tsx           # Entry point
│   ├── index.html
│   ├── vite.config.ts
│   ├── tsconfig.json
│   └── package.json
├── build/popup/               # Compiled popup (generated by Vite)
└── icons/                     # Extension icons (16, 48, 128px)
```

## Core Components

### Service Worker (serviceWorker.js)
- **Role**: Main orchestrator and background process coordinator
- **Responsibilities**:
  - Listens for alarms and commands
  - Coordinates deduplication workflow
  - Manages rate limiting and storage
  - Handles extension lifecycle events
- **Key APIs**: chrome.alarms, chrome.commands, chrome.runtime

### OpenAI Client (openaiClient.js)
- **Role**: Azure OpenAI API wrapper
- **Responsibilities**:
  - Manages API authentication
  - Handles chat completions
  - Generates embeddings
  - Implements retry logic
- **Configuration**: Reads from chrome.storage.sync

### Embeddings Module (embeddings.js)
- **Role**: Vector generation and duplicate detection
- **Responsibilities**:
  - Generates embeddings for bookmarks
  - Compares vectors using cosine similarity
  - Identifies duplicate clusters
  - Caches vectors in storage
- **Dependencies**: openaiClient, storageManager, duplicateDetector

### Scraper (scraper.js + offscreenScraper.js)
- **Role**: Page content extraction
- **Responsibilities**:
  - Creates offscreen documents for DOM parsing
  - Extracts page titles and meta descriptions
  - Handles scraping errors gracefully
- **Pattern**: MV3 offscreen document pattern (Chrome 116+)

### Writer (writer.js)
- **Role**: Bookmark mutation operations
- **Responsibilities**:
  - Updates bookmark titles and URLs
  - Deletes bookmarks
  - Moves bookmarks between folders
- **API**: chrome.bookmarks

### Utilities Layer (utils/)
- **rateLimiter.js**: Token bucket algorithm for API throttling
- **storageManager.js**: Vector cache with TTL and quota management
- **notificationManager.js**: User-facing progress updates
- **duplicateDetector.js**: Cosine similarity threshold comparison
- **tagValidator.js**: Filters low-quality or irrelevant tags
- **folderOrganizer.js**: Suggests folder placement based on content
- **syncManager.js**: Resolves conflicts in sync storage
- **offscreen.js**: Manages offscreen document lifecycle

## Architectural Patterns

### MV3 Service Worker Pattern
- Background script runs as service worker (not persistent)
- Uses chrome.alarms for scheduled tasks (survives worker termination)
- Offscreen documents for DOM operations (no direct DOM access in service worker)
- runtime.getContexts() for lifecycle management

### Modular Design
- Clear separation of concerns (API, storage, UI, business logic)
- Utility modules are stateless and reusable
- Core modules depend on utilities, not vice versa

### Storage Strategy
- **chrome.storage.sync**: User settings (~100 KB limit)
- **chrome.storage.local**: Vector cache and review queue (unlimited with permission)
- **Device-only mode**: Option to use local storage instead of sync for large datasets

### Rate Limiting
- Custom implementation (no external dependencies)
- Configurable concurrent request limit (default: 8)
- Exponential backoff with 3 retries
- Prevents API quota exhaustion

### Caching Strategy
- Vectors cached with 30-day TTL
- Cache key: bookmark URL + content hash
- Automatic expiration and quota management
- Reduces API costs on subsequent runs

## Component Relationships

```
serviceWorker.js (orchestrator)
    ├─> openaiClient.js (API wrapper)
    ├─> embeddings.js
    │       ├─> openaiClient.js
    │       ├─> storageManager.js
    │       └─> duplicateDetector.js
    ├─> tagger.js
    │       └─> openaiClient.js
    ├─> scraper.js
    │       └─> offscreenScraper.js (via offscreen document)
    ├─> writer.js
    └─> utils/
            ├─> rateLimiter.js
            ├─> storageManager.js
            ├─> notificationManager.js
            └─> [other utilities]

popup/ (React app)
    └─> chrome.runtime.sendMessage() → serviceWorker.js

options/ (vanilla JS)
    └─> chrome.storage.sync (settings)
```

## Data Flow

1. **Scheduled Cleanup**:
   - Alarm triggers → serviceWorker.js
   - Fetch bookmarks → chrome.bookmarks API
   - Generate embeddings → openaiClient.js
   - Detect duplicates → duplicateDetector.js
   - Store in review queue → chrome.storage.local
   - Notify user → notificationManager.js

2. **Manual Review**:
   - User opens popup → App.tsx
   - Fetch review queue → chrome.storage.local
   - User accepts/rejects → writer.js
   - Update bookmarks → chrome.bookmarks API

3. **Import/Export**:
   - Export: chrome.bookmarks → exporter.js → Netscape HTML → chrome.downloads
   - Import: File upload → importer.js → parse HTML → bookmarksCrud.js → chrome.bookmarks
